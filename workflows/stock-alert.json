{
  "name": "stock-alert",
  "nodes": [
    {
      "parameters": {
        "triggerTimes": {
          "item": [
            {
              "hour": 7,
              "minute": 1
            }
          ]
        }
      },
      "name": "–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ 8:00",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [
        0,
        0
      ],
      "id": "770424d9-f09c-42f3-9fc0-29411513fc7f"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT\n  d.name AS drug_name,\n  w.name AS warehouse_name,\n  pt.name AS package_type,\n  s.quantity,\n  s.daily_usage,\n  s.threshold\nFROM stock s\nJOIN drugs d ON s.drug_id = d.id\nJOIN warehouses w ON s.warehouse_id = w.id\nJOIN package_types pt ON d.package_type_id = pt.id\nWHERE s.quantity < s.threshold OR (s.daily_usage > 0 AND s.quantity::FLOAT / s.daily_usage < 3);",
        "options": {}
      },
      "name": "–ß—Ç–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø–æ–∑–∏—Ü–∏–π –∏–∑ –ë–î",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [
        208,
        0
      ],
      "id": "83e651f0-3806-4372-a4f7-4a0e35a4d74f",
      "credentials": {
        "postgres": {
          "id": "YMm88yQI7M18lNM2",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "const results = [];\n\nfor (const item of items) {\n  const { drug_name, warehouse_name, package_type, quantity, daily_usage, threshold } = item.json;\n\n  const daysLeft = daily_usage > 0 ? (quantity / daily_usage).toFixed(1) : '‚àû';\n  const isLowStock = quantity < threshold;\n  const isCritical = daily_usage > 0 && quantity / daily_usage < 3;\n\n  if (isLowStock || isCritical) {\n    results.push({\n      json: {\n        ...item.json,\n        days_left: daysLeft,\n        alert_reason: isLowStock && isCritical\n          ? '–Ω–∏–∑–∫–∏–π –æ—Å—Ç–∞—Ç–æ–∫ + —Å–∫–æ—Ä–æ –∑–∞–∫–æ–Ω—á–∏—Ç—Å—è'\n          : isLowStock\n          ? '–æ—Å—Ç–∞—Ç–æ–∫ –Ω–∏–∂–µ –ø–æ—Ä–æ–≥–∞'\n          : '–∑–∞–∫–æ–Ω—á–∏—Ç—Å—è –º–µ–Ω–µ–µ —á–µ–º —á–µ—Ä–µ–∑ 3 –¥–Ω—è'\n      }\n    });\n  }\n}\n\nreturn results;"
      },
      "name": "–ê–Ω–∞–ª–∏–∑ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        400,
        0
      ],
      "id": "dbeaf81b-8e98-493e-81b7-c1e848cc610e"
    },
    {
      "parameters": {
        "chatId": "1176202075",
        "text": "=‚ö†Ô∏è –ù–∏–∑–∫–∏–π –∑–∞–ø–∞—Å –Ω–∞ —Å–∫–ª–∞–¥–µ!\n\nüíä –ü—Ä–µ–ø–∞—Ä–∞—Ç: {{$json[\"drug_name\"]}}\nüè¢ –°–∫–ª–∞–¥: {{$json[\"warehouse_name\"]}}\nüî¢ –û—Å—Ç–∞—Ç–æ–∫: {{$json[\"quantity\"]}}\nüìâ –†–∞—Å—Ö–æ–¥: {{$json[\"daily_usage\"]}}/–¥–µ–Ω—å\n‚è≥ –ó–∞–∫–æ–Ω—á–∏—Ç—Å—è —á–µ—Ä–µ–∑: {{$json[\"days_left\"]}} –¥–Ω–µ–π\n‚ùó –ü—Ä–∏—á–∏–Ω–∞: {{$json[\"alert_reason\"]}}\n\nüëâ –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ!",
        "additionalFields": {}
      },
      "name": "–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        608,
        0
      ],
      "id": "476541c4-d708-44e2-b4cb-d6a4b9291796",
      "webhookId": "578d14d2-df7f-4cd5-99b6-bd6de8ffdbea",
      "credentials": {
        "telegramApi": {
          "id": "Y15VPZdsdzBkp3KB",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -16,
        -224
      ],
      "id": "f45e9f07-4d8b-42ee-a9e0-a0c4bd9cf748",
      "name": "When clicking ‚ÄòExecute workflow‚Äô",
      "disabled": true
    }
  ],
  "pinData": {},
  "connections": {
    "–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ 8:00": {
      "main": [
        [
          {
            "node": "–ß—Ç–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø–æ–∑–∏—Ü–∏–π –∏–∑ –ë–î",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–ß—Ç–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø–æ–∑–∏—Ü–∏–π –∏–∑ –ë–î": {
      "main": [
        [
          {
            "node": "–ê–Ω–∞–ª–∏–∑ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–ê–Ω–∞–ª–∏–∑ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ": {
      "main": [
        [
          {
            "node": "–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When clicking ‚ÄòExecute workflow‚Äô": {
      "main": [
        [
          {
            "node": "–ß—Ç–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø–æ–∑–∏—Ü–∏–π –∏–∑ –ë–î",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "05ecaa0c-c2e4-432e-bba0-99fdba904460",
  "meta": {
    "instanceId": "e23a5978e6ea9ed59a73427fff5ecc70f24669c3c4d7c9cdedbb05f32695749d"
  },
  "id": "fzdpH6VbslkWVFiG",
  "tags": []
}